<!-- TOC -->

- [**一、Eureka 服务注册与组件发现**](#一eureka-服务注册与组件发现)
- [**二、Ribbon 服务消费者**](#二ribbon-服务消费者)
- [**三、Feign 服务消费者**](#三feign-服务消费者)
- [**四、Hystrix 断路器**](#四hystrix-断路器)
- [**五、Zuul 路由网关与请求分发**](#五zuul-路由网关与请求分发)
- [**六、Config 分布式配置中心**](#六config-分布式配置中心)
- [**七、Bus 消息总线**](#七bus-消息总线)
- [**八、Sleuth 服务链路追踪**](#八sleuth-服务链路追踪)
- [**九、Gateway 二代网关**](#九gateway-二代网关)

<!-- /TOC -->


# **一、Eureka 服务注册与组件发现**
1. Eureka是Netflix开发的服务发现组件，本身是一个基于REST的服务。Spring Cloud将它集成在其子项目spring-cloud-netflix中，以实现Spring Cloud的服务发现功能。
	
2. *为什么要使用Eureka*？因为在一个完整的系统架构中，任何单点的服务都不能保证不会中断，因此我们需要服务发现机制，在某个节点中断后，其它的节点能够继续提供服务，从而保证整个系统是高可用的。
	
3. Eureka Server会提供服务注册服务，各个服务节点启动后，会在Eureka Server中进行注册，这样Eureka Server中就有了所有服务节点的信息，并且Eureka有监控页面，可以在页面中直观的看到所有注册的服务的情况。同时Eureka有心跳机制，当某个节点服务在规定时间内没有发送心跳信号时，Eureka会从服务注册表中把这个服务节点移除。

4. Eureka还提供了客户端缓存的机制，即使所有的Eureka Server都挂掉，客户端仍可以利用缓存中的信息调用服务节点的服务。Eureka一般配合Ribbon进行使用，Ribbon提供了客户端负载均衡的功能，Ribbon利用从Eureka中读取到的服务信息，在调用服务节点提供的服务时，会合理的进行负载。

5. Eureka通过心跳检测、健康检查、客户端缓存等机制，保证了系统具有高可用和灵活性。

6. 当成千上万个服务(Eureka Client)向它注册的时候，它的负载是非常高的，这在生产环境上是不太合适的。这时可以考虑将Eureka 注册中心做成一个微服务，将其集群化，从而达到高可用。注册中心之间相互感应，当有服务注册时，集群中的Eureka-eserver是对等的，它们都存有相同的信息，这就是通过服务器的冗余来增加可靠性，当有一台服务器宕机了，服务并不会终止，因为另一台服务存有相同的数据


# **二、Ribbon 服务消费者**
1. 在微服务架构中，业务都会被拆分成一个独立的服务，服务与服务的通讯是基于http restful的。Spring Cloud Ribbon是一个基于HTTP和TCP的客户端负载均衡工具，它基于Netflix Ribbon实现。通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。

2. 负载均衡在系统架构中是一个非常重要，并且是不得不去实施的内容。因为负载均衡是对系统的高可用、网络压力的缓解和处理能力扩容的重要手段之一。我们通常所说的负载均衡都指的是服务端负载均衡，其中分为硬件负载均衡和软件负载均衡。硬件负载均衡主要通过在服务器节点之间按照专门用于负载均衡的设备，比如F5等；而软件负载均衡则是通过在服务器上安装一些用于负载均衡功能或模块等软件来完成请求分发工作，比如Nginx等。

3. 硬件负载均衡的设备或是软件负载均衡的软件模块都会维护一个下挂可用的服务端清单，通过心跳检测来剔除故障的服务端节点以保证清单中都是可以正常访问的服务端节点。当客户端发送请求到负载均衡设备的时候，该设备按某种算法（比如线性轮询、按权重负载、按流量负载等）从维护的可用服务端清单中取出一台服务端端地址，然后进行转发。

4. 通过Spring Cloud Ribbon的封装，我们在微服务架构中使用客户端负载均衡调用非常简单，只需要如下两步：       
   - 服务提供者只需要启动多个服务实例并注册到一个注册中心或是多个相关联的服务注册中心。        
   - 服务消费者直接通过调用被@LoadBalanced注解修饰过的RestTemplate来实现面向服务的接口调用。


# **三、Feign 服务消费者**
1. Feign是Netflix开发的声明式、模板化的HTTP客户端， Feign可以帮助我们更快捷、优雅地调用HTTP API。

2. 在Spring Cloud中，使用Feign非常简单——创建一个接口，并在接口上添加一些注解，代码就完成了。Feign支持多种注解，例如Feign自带的注解或者JAX-RS注解等。

3. Spring Cloud对Feign进行了增强，使Feign支持了Spring MVC注解，并整合了Ribbon和Eureka，从而让Feign的使用更加方便。

4. Spring Cloud Feign是基于Netflix feign实现，整合了Spring Cloud Ribbon和Spring Cloud Hystrix，除了提供这两者的强大功能外，还提供了一种声明式的Web服务客户端定义的方式。

5. Spring Cloud Feign帮助我们定义和实现依赖服务接口的定义。在Spring Cloud feign的实现下，只需要创建一个接口并用注解方式配置它，即可完成服务提供方的接口绑定，简化了在使用Spring Cloud Ribbon时自行封装服务调用客户端的开发量。

6. Spring Cloud Feign具备可插拔的注解支持，支持Feign注解、JAX-RS注解和Spring MVC的注解。


# **四、Hystrix 断路器**
1. 在微服务架构中，根据业务来拆分成一个个的服务，服务与服务之间可以相互调用（RPC），在Spring Cloud可以用RestTemplate+Ribbon和Feign来调用。为了保证其高可用，单个服务通常会集群部署。由于网络原因或者自身的原因，服务并不能保证100%可用，如果单个服务出现问题，调用这个服务就会出现线程阻塞，此时若有大量的请求涌入，Servlet容器的线程资源会被消耗完毕，导致服务瘫痪。服务与服务之间的依赖性，故障会传播，会对整个微服务系统造成灾难性的严重后果，这就是服务故障的“雪崩”效应。

2. Hystrix是Netflix开源的服务故障隔离、恢复、监控和报警的组件。Hystrix通过添加对被依赖服务延迟和故障处理逻辑控制服务间的交互，进而提高整个系统的稳定性。

3. hystrix提供了以下这些功能帮组我们应对这种情况：
   - 在被依赖服务出现故障或则延迟时，对依赖服务提供必要保护措施
   - 提供预防复杂分布式系统中的级连失败问题的机制
   - 提供被依赖服务错误快速返回和快速恢复功能
   - 提供快速回退和降级功能
   - 提供近实时的监控、报警和操作控制

4. hystrix设计理念概要：
   - 控制单一依赖对容器线程资源的消耗
   - 消峰和快速失败返回而不是进行排队操作
   - 在故障发生时提供默认值的返回
   - 使用故障（延迟）隔离技术手段防止对其他服务产生重大影响
   - 通过实时的统计、监控和报警优化故障恢复


# **五、Zuul 路由网关与请求分发**
1. Zuul的主要功能是路由转发和过滤器。路由功能是微服务的一部分，比如／api/user转发到到user服务，/api/shop转发到到shop服务。zuul默认和Ribbon结合实现了负载均衡的功能。

2. Zuul相当于是第三方调用（app应用端和PC端）和服务提供方之间的防护门。作为前端服务（Edge Service也称边缘服务，前端服务的作用是对后端服务做必要的聚合和裁剪后暴露给外部不同的设备，如PC，Pad或者Phone），Zuul旨在实现动态路由，监控，弹性和安全性。它具备根据需求将请求路由到多个AWS自动弹性伸缩组的能力。

3. 使用网关优点：
- 易于监控，可在微服务网关收集监控数据并将其推送到外部系统进行分析。
- 易于认证，可在微服务网关上进行认证。然后再将请求转发到后端的微服务，而无须在每个微服务中进行认证。
- 减少了客户端与各个微服务之间的交互次数。

4. 服务网关是微服务架构中一个不可或缺的部分。通过服务网关统一向外系统提供REST API的过程中，除了具备服务路由、均衡负载功能之外，它还具备了权限控制等功能。Spring Cloud Netflix中的Zuul就担任了这样的一个角色，为微服务架构提供了前门保护的作用，同时将权限控制这些较重的非业务逻辑内容迁移到服务路由层面，使得服务集群主体能够具备更高的可复用性和可测试性。

5. Netflix API流量的量级和多样性随时可能导致生产环境故障而没有预警。因此需要一个系统能使我们迅速改变策略行为，以便应对各种情况。 Zuul使用一些不同类型的过滤器，使我们能够快速灵活地将功能应用于我们的前端服务。这些过滤器具有以下功能：
   - 权限控制和安全性--为每个请求提供身份认证，并拒绝不满足条件的请求。
   - 预警和监控--跟踪前端有意义的请求和统计数据，以便我们准确了解生产环境运行状况。
   - 动态路由--根据需求将请求动态地路由到不同的后端集群。
   - 压力测试--逐渐增大到集群的流量，以便进行性能评估。
   - 负载均衡--为每种类型的请求分配容量并丢弃超过限额的请求。
   - 静态资源处理--直接在Zuul处理静态资源并响应，而并非转发这些请求到内部集群中。
   - 多区域弹性--实现跨AWS区域请求路由，扩大了ELB的使用范围，并使前端服务更接近我们的成员。


# **六、Config 分布式配置中心**
1. 在分布式系统中，由于服务数量巨多，为了方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件。在Spring Cloud中，有分布式配置中心组件spring cloud config ，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中。在spring cloud config 组件中，分两个角色，一是config server，二是config client。

2. 客户端并不能主动感知到配置的变化，从而主动去获取新的配置，这需要每个客户端通过POST方法触发各自的/refresh。

3. bootstrap.yml（bootstrap.properties）与application.yml（application.properties）执行顺序：
- bootstrap.yml（bootstrap.properties）用来程序引导时执行，应用于更加早期配置信息读取，如可以使用来配置application.yml中使用到参数等
- application.yml（application.properties) 应用程序特有配置信息，可以用来配置后续各个模块中需使用的公共参数等。
- bootstrap.yml 先于 application.yml 加载

4. **当服务实例很多时，都从配置中心读取文件，这时可以考虑将配置中心做成一个微服务，将其集群化，从而达到高可用**


# **七、Bus 消息总线**
1. 在微服务架构的系统中，我们通常会使用轻量级的消息代理来构建一个共用的消息主题让系统中所有微服务实例都连接上来，由于该主题中产生的消息会被所有实例监听和消费，所以我们称它为消息总线。
   
2. spring cloud bus在整个后端服务中起到联通的作用，联通后端的多台服务器。我们为什么需要他做联通呢？

3. 后端服务器一般都做了集群化，很多台服务器，而且在大促活动期经常发生服务的扩容、缩容、上线、下线。这样，后端服务器的数量、IP就会变来变去，如果我们想进行一些线上的管理和维护工作，就需要维护服务器的IP。

4. 比如我们需要更新配置、比如我们需要同时失效所有服务器上的某个缓存，都需要向所有的相关服务器发送命令，也就是调用一个接口。

5. 总的来说，就是在我们需要把一个操作散发到所有后端相关服务器的时候，就可以选择使用cloud bus了。


# **八、Sleuth 服务链路追踪**
1. Spring Cloud Sleuth 主要功能就是在分布式系统中提供追踪解决方案，并且兼容支持了 zipkin，你只需要在pom文件中引入相应的依赖即可。

2. 微服务架构上通过业务来划分服务的，通过REST调用，对外暴露的一个接口，可能需要很多个服务协同才能完成这个接口功能，如果链路上任何一个服务出现问题或者网络超时，都会形成导致接口调用失败。随着业务的不断扩张，服务之间互相调用会越来越复杂。

3. **基本术语：**
    - Span是基本的工作单元。Span包括一个64位的唯一ID，一个64位trace码，描述信息，时间戳事件，key-value 注解(tags)，span处理者的ID（通常为IP）。最开始的初始Span称为根span，此span中span id和 trace id值相同。
    - Trace包含一系列的span，它们组成了一个树型结构

4. Annotation用于及时记录存在的事件。常用的Annotation如下:
   - cs - Client Sent：客户端发送一个请求，表示span的开始
   - sr - Server Received：服务端接收请求并开始处理它。(sr-cs)等于网络的延迟
   - ss - Server Sent：服务端处理请求完成，开始返回结束给服务端。(ss-sr)表示服务端处理请求的时间
   - cr - Client Received：客户端完成接受返回结果，此时span结束。(cr-sr)表示客户端接收服务端数据的时间


# **九、Gateway 二代网关**
1. Spring Cloud Gateway是Spring Cloud官方推出的第二代网关框架，取代Zuul网关。网关作为流量的，在微服务系统中有着非常作用，网关常见的功能有路由转发、权限校验、限流控制等作用。

2. Spring Cloud Gateway的特征：
   - Java 8
   - Spring Framework 5
   - Spring Boot 2
   - 动态路由
   - 内置到Spring Handler映射中的路由匹配
   - 基于HTTP请求的路由匹配 (Path, Method, Header, Host, etc…)
   - 过滤器作用于匹配的路由
   - 过滤器可以修改下游HTTP请求和HTTP响应 (Add/Remove Headers, Add/Remove Parameters, Rewrite Path, Set Path, Hystrix, etc…​)
   - 通过API或配置驱动
   - 支持Spring Cloud DiscoveryClient配置路由，与服务发现与注册配合使用

